#!/usr/bin/env bash
#	Yet Another Simple Script Installer
# ------------------------------------------------------------------------
#
#	Created:	2015.07.27
#	Changed:	2015.09.21
	script_name=configure
	script_version=1.0.2
#
#	Description:
#		This script automaticly, according to passed options, 
#		generates the following files, named to go along with GNU Automake terminology.
#		* make-install
#		* make-uninstall
#		* make-distclean
#		
#		The options were applied from the output of GNU Automake's './configure --help'
#		and the calculation of the paths is done according to: http://www.pathname.com/fhs/
#
#		This is not about auto magic compiling,
#		this is about simply placing files.
#
#
#	To report bugs or suggestions about YASSI (configure), please raise an issue on:
#		https://github.com/sri-arjuna/yassi/issues
#	or send me an email.
#
# ------------------------------------------------------------------------
#
# Copyright (c) 2015 Simon Arjuna Erat (sea)  <erat.simon@gmail.com>
# All rights reserved.
#
# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>
#
# ------------------------------------------------------------------------
#
#	Configfile / Option defaults
#
	APP=""
	APP_VER=""
	APP_REQUIRES=""
	CFG_REQUIRES=""
	BUGS=""
	ISSUE=""
	doRef=false
	doTarball=false
	is_at_home=false
#
#	Internal Variables
#
	unset FHS PREPARE PRIOR POST REMOVE
	declare -A FHS
	declare -a PREPARE	# This will be ran during ./configure --prefix=/usr
	declare -a PRIOR	# This will be ran first during ./make-install
	declare -a POST		# This will be ran last during ./make-install
	declare -a REMOVE	# This will be ran during ./make-uninstall
	declare -a CLEAN	# This will be ran during ./make-distclean
	declare -a IGNORE	# These files will be ignored when running './configure --tarball --prefix=/usr'
	AWK=\awk
	GREP=\grep
	SED=\sed
	CONFIG="./$script_name.cfg"
	which sudo 1>/dev/zero 2>/dev/zero && \
		install_prefix="sudo " || \
		install_prefix="su -c "
	#LOG="${PWD:-$(pwd)}/make-install.log"		# Not yet used, see lines 214 + 215 for most important application
	mandirs="$(echo man{1..9}dir)"
	index_list="prefix bindir sbindir sysconfdir datarootdir datadir docdir htmldir infodir $mandirs compldir sharedstatedir localstatedir"
	variable_list="";for i in $index_list;do variable_list+=" ${i^^}";done
	TMP="$PWD/tmp.$$"
	CHROOT=""
	source "$CONFIG"
#
#	Functions
#
	show_sample() {
	# Prints a sample configure.cfg
	# and exits
		cat <<-EOF
		#
		#	Project Info
		#
		 	APP=projectname
		 	APP_REQUIRES="awk bash grep sed"
		#
		#	Targets
		#
		 	BINDIR=bin
		 	DOCDIR=docs/[A-Z]*
		 	MAN1DIR=docs/man/\*.1
		 	INFODIR=docs/info/\*.info
		 	DATADIR="./templates ./extra"
		#
		#	Contact
		#
		 	BUGS="$USER AT $HOSTNAME"
		EOF
		exit 0
	}
	show_sample_full() {
	# Prints an advanced sample configure.cfg
	# and exits
		cat <<-EOF
		#
		#	Project Info
		#
		 	# Used for /usr/share/\$APP & /usr/share/doc/\$APP
		 	APP=projectname
		 	APP_REQUIRES="awk bash grep sed"
		 	CFG_REQUIRES="git texi2any txt2man"
		 	
		 	# Used for helpscreen & tarball
		 	APP_VER=0.1
		 	
		 	# If set, overwrites the default PREFIX (/usr/local) to assigned value.
		 	#APP_DIR=~/.local
		 	
		 	# Set true to install the reference file to $PREFIX/$SYSCONFDIR/\$APP.conf
		 	# This will automaticly be uninstalled if set to true, no extra work.
		 	#doRef=false
		#
		#	Prepare, before making a tarball
		#	So the CFG_REQUIRES are only needed on one machine, and the tarball then can be shared 
		#
		 	PREPARE[0]="texi2any -o docs/info/\$APP.info --no-split docs/info/\$APP.texi"
		 	PREPARE[1]="texi2any --html -o docs/info/\$APP.html --no-split docs/info/\$APP.texi"
		 	PREPARE[2]="which tuirc 1>/dev/zero 2>/dev/zero || git clone https://github.com/sri-arjuna/tui tui"
		 	PREPARE[3]="bin/\$APP --help | txt2man -T \${APP^^} -r \$APP_VER > docs/man/\$APP.1"
		#
		#	Tasks prior to installation, but after tarball
		#
		 	# Only install if the current system does not provide TUI
		 	PRIOR[0]="! which tuirc 1>/dev/zero 2>/dev/zero && cd tui && ./configure --prefix=${prefix} && (./make-install || make install) && cd .. "
		#
		#	Targets, where is what installed
		#
		 	BINDIR=bin
		 	DOCDIR=docs/[A-Z]*
		 	MAN1DIR=docs/man/*.1
		 	INFODIR=docs/info/\$APP.info
		 	HTMLDIR=docs/info/\$APP.html
		 	DATADIR="./menu ./includes"
		#
		#	Task prior to the installation
		#
		 	PRIOR[0]="echo 'Some variable examples:'"
		 	PRIOR[1]="printf '* %s\n' \"CHROOT=\\\$CHROOT\" \"prefix=\\\$prefix\" \"SYSCONFDIR=\\\$SYSCONFDIR\" \"DATADIR=\\\$DATADIR\";read -p 'press enter to continue' buffer"
		#
		#	Tasks post of installation
		#
		 	POST[0]=scripts/post_script1.sh
		 	POST[1]="echo \"Thank you for choosing '\$APP'!\""
		#
		#	Clean up what has been prepared 
		#
		 	CLEAN[0]="docs/info/\$APP.html"
		 	CLEAN[0]="docs/info/\$APP.info"
		#
		#	Additional tasks for the uninstallation process
		#
		 	REMOVE[0]="tui-yesno 'Remove TUI as well?' && cd tui && \\
		 			./make-uninstall && \
		 			./make-distclean && cd .."
		#
		#	Contact
		#
		 	BUGS="your@email.com"
		 	ISSUE="https://github.com/sri-arjuna/yassi/issues"
		EOF
		exit 0
	}
	show_help() {
	# Prints the helpscreen
	# and exits
		MSG_TR_CONTACT_INFO="$( [ ! -z "$BUGS" ] && echo -e "\nReport bugs of \"$APP\" to \"$BUGS\"")$( [ ! -z "$ISSUE" ] && printf "\nReport bugs of \"$APP\" on \"$ISSUE\"\n \n")"
		
		MSG_TR_HELP="
Usage:	./$script_name [options]
Routine to configure the installation of ${APP:-APPNAME} ${APP_VER}

OPTIONS:
	-h|--help		Shows this screen and exits
	--version		Shows the version and exits
	
	--sample		Prints a sample 'configure.cfg' required by projects and exits
	--sample-full		Prints an advanced sample 'configure.cfg' required by projects and exits
	--tarball		Configures ${APP:-APPNAME}, runs PRIOR tasks and saves the folder as tarball, then exits
	
	--prefix DIR		Sets the prefix to DIR		(default: ${APP_DIR:-/usr/local})
	--chroot DIR		Sets the CHROOT to DIR		(for 'builddirs' or before chrooting into a partition)
	
	--bindir DIR		user executeables 		(\$prefix/bin)
	--sbindir DIR		admin executeables		(\$prefix/sbin)
	--sysconfdir DIR	read-only single-machine data 	(\$prefix/etc)
	--datarootdir DIR	read-only arch.-independent data root 	(\$prefix/share)
	
	--datadir DIR		read-only architecture-independent data (\$DATAROOTDIR/${APP:-APPNAME})
	--docdir DIR		project documentation root	(\$DATAROOTDIR/doc/${APP:-APPNAME})
	--htmldir DIR		project documentation root	(\$DOCDIR)
	--infodir DIR		info documentation		(\$DATAROOTDIR/info)
	
	--compldir DIR		bash completion			(\$DATAROOTDIR/bash-completion/completions)
	--localedir		locale-dependent data		(\$DATAROOTDIR/locale)
	--localstatedir		modifiable single-machine data	(\$prefix/var)
	
	--man1dir DIR		man 1 Exe & Shell commands	(\$DATAROOTDIR/man/man1)
	-	2) System calls		3) Library calls	4) Special files (eg /dev)
	-	5) File formats & conventions (eg: /etc/passwd)	6) Games
	-	7) Miscellaneous (eg: macros, groff)		8) Root commands (sbin)
	--man9dir DIR		man 9 Kernel routines (non standard)	(\$DATAROOTDIR/man/man9)
	
	--sharedstatedir	modifiable architecture-independent	(\$prefix/com)
$MSG_TR_CONTACT_INFO
YASSI (Yet Another Simple Script Installer, ./$script_name), was written in 2015 by Simon Arjuna Erat (sea), Switzerland
"
		echo "$MSG_TR_HELP"
		exit 99
	}
	show_version() {
	# Prints the version of the script
	# and exits
		MSG_TR_VERSION="(sea) $script_name, Version $script_version
Copyright (C) 2015 Simon Arjuna Erat
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>

This is free software; you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Report bugs of $script_name to: https://github.com/sri-arjuna/yassi/issues
"
		echo "$MSG_TR_VERSION"
		exit 111
	}
	write_files() { 
	# Write the different types of make-{distclean,install,uninstall} scripts
	# An run pre-'make-install'-tasks
		# Abort with failure if not all required apllication are present
		APP_REQUIRES=""
		source "$CONFIG";missing=""
		for req in $CFG_REQUIRES;do
			which $req 2>/dev/zero 1>&2 || missing+=" $req"
		done
		[ ! -z "$missing" ] && \
			printf '%s\n' "Please provide these commands before configuring $APP!" "Sadly, you must figure out the package name yourself." && \
			printf '::-->> %s\n' ${missing} && \
			exit 1
		write_install() { # INDEX CONTENT
		# Prints the copy commands
		#
			fullPath="${2/$CHROOT}"
			if [ -d "$2" ] && [ ! "./" = "${fullPath:0:2}" ]
			then	# Its a directory, go recursive
				echo "cp -ar \"${PWD:-$(pwd)}/$2/\"* \"${CHROOT}${FHS[${1,,}]}\" || exit 1" | sed s,"//","/",g
			else	tmp_check="${2##*/}"
				check_char="${tmp_check:0:1}"
				isAsterix=$(printf '%s' "$check_char" | grep -v '*' && echo false || echo true )
				
				case "$isAsterix" in
				true|false)	isAsterix=$isAsterix	;;
				*)		isAsterix=false		;;
				esac
				
				if $isAsterix
				then 	echo "cp -ar \"${PWD:-$(pwd)}/$(dirname ${2})/\"$tmp_check \"${CHROOT}${FHS[${1,,}]}\" || exit 1" | sed s,"//","/",g
				else	echo "cp -a \"${PWD:-$(pwd)}/$2\" \"${CHROOT}${FHS[${1,,}]}\" || exit 1" | sed s,"//","/",g
				fi
			fi
		}
		write_reference() { # INDEX
		# Prints the index reference used
		#
			ref_val="${FHS[${1,,}]}"
			echo "${1}=$ref_val"  | sed s,"//","/",g
		}
		write_uninstall() { # INDEX CONTENT
		# Prints the remove commands
		#
			INDEX="$1" ; shift
			DEST="${CHROOT}${FHS[${INDEX,,}]}"
			
			for tr in ${@}
			do	case "$INDEX" in
				SBINDIR|BINDIR|MAN[1-9]DIR)
					if [ -d "${tr}" ]
					then	for e in "./$tr/"*
						do 	[ -d "$e" ] && \
								echo "rm -fr $DEST/${e##*/}" || \
								echo "rm -f $DEST/${e##*/}"
						done
					else	echo "rm -f $DEST/${tr##*/}"
					fi
					;;
				COMPLDIR)
					tr="${tr/\$\{APP\}/$APP}"
					echo "rm -f $DEST/${tr##*/}"
					;;
				*)	[ -d "$tr" ] && \
						echo "rm -fr $DEST/${tr##*/}" || \
						echo "rm -f $DEST/${tr##*/}"
					;;
				esac
			done
			return 0
		}
		write_distclean() { 
		# Remove the files that where created
		#
			cat <<-EOF
			
			rm -f "$REFERENCE"
			rm -f ./make-* 
			EOF
		}
		
		# Prepare script headers
		for m in install uninstall distclean
		do	echo "#!/usr/bin/env sh" > "make-$m"
			if [ ! "$m" = "distclean" ] && ! $is_at_home 
			then	echo "$CHROOT/$prefix"| grep -q -ve /home -ve /Users && \
						printf '%s\n' \
						"[ -z \$UID ] && UID=0" \
						"[ \$UID -ne 0 ] && \\" \
						"	echo \"To $m '$APP', root access is required.\" && \\" \
						"	exit 99" >> "make-$m"
			#else	echo "set -x" >> "make-$m"
			fi
			echo "set -x" >> "make-$m"
			chmod +x "make-$m"
		done
		$is_at_home && FHS[prefix]="$prefix_home"
		echo "prefix=${FHS[prefix]}">"$REFERENCE"
		if [ -n "$CHROOT" ] 
		then	echo "CHROOT=$CHROOT" >> "make-install"
			echo "CHROOT=$CHROOT" >> "make-uninstall"
		fi
		
		# Write content of PRIOR tasks, if any
		if [ -n "$(echo ${PRIOR[@]})" ]
		then	source "$PWD/$REFERENCE"	# Just prefix yet
			C=0
			echo >> "make-install"
			while 	item="${PRIOR[$C]}"
			[ ! -z "$item" ]
			do 	[ -f "$item" ] && \
					echo "bash ./$item" >> "make-install" || \
					echo "$item" >> "make-install" #  || exit 1
				((C++))
			done
		fi
		
		# Search for the available/used variables
		for index in $variable_list
		do	# Expand index
			tmp="${!index}"
			# Count words
			num=$(echo "$tmp" | wc -w)
			
			# Only do something if index has content count higher than 0
			if [ "$num" -gt 0 ]
			then	# 'Group' different tasks 
				echo >> "make-install"
				echo >> "make-uninstall"
				
				# It has content
				write_reference "$index" >> "$REFERENCE"
				set $index
				# This usualy is the most important fix, sadly
				cat >> "make-install" <<-EOF
				tmp_str="${FHS[${1,,}]}"
				if [ ! -d "\${CHROOT}\${tmp_str%/*}" ]
				then 	cd "\${CHROOT}/usr/.."
				 	[ -d "\${CHROOT}/usr\${tmp_str%/*}" ] && \\
				 		ln -sf "./usr\${tmp_str%/*}" "./\${tmp_str%/*}" || \\
				 		mkdir -p "\${CHROOT}\$tmp_str"
				 	cd "\$OLDPWD"
				fi
				EOF
				case "$num" in
				1)	write_install "$index" "$tmp" >> "make-install"
					write_uninstall "$index" "$tmp" >> "make-uninstall"
					;;
				*)	for s in $(echo "$tmp"|sed s,\",,g)
					do 	write_install "$index" "$s" >> "make-install"
						write_uninstall "$index" "$s" >> "make-uninstall"
					done
					;;
				esac
			fi
		done
		source "$PWD/$REFERENCE"
	#
	# 	Finalize
	#
		# Uninstall
		if [ -n "$(echo ${REMOVE[@]})" ]
		then 	C=0
			echo >> "make-uninstall"
			
			while 	item="${REMOVE[$C]}"
				[ ! -z "$item" ]
			do 	[ -f "$item" ] && \
					echo "rm -f $item" >> "make-uninstall" || \
					echo "$item" >> "make-uninstall"
				((C++))
			done
		fi
		# Now remove hardcoded folders that were used
		for D in data doc
		do 	d="${FHS[${D}dir]}"
			[ -n "$d" ] && \
				echo "[ -d \"\${CHROOT}$d\" ] && rm -fr \${CHROOT}$d" >> "make-uninstall"
		done
		
		# Check for DISTCLEAN operations
		if [ -n "$(echo ${CLEAN[@]})" ]
		then 	C=0
			echo >> "make-distclean"
			
			while 	item="${CLEAN[$C]}"
				[ -n "$item" ]
			do 	( [ -f "./$item" ] || [ -f "$item" ] ) && \
					echo "rm -f $item" >> "make-distclean" || \
					echo "$item" >> "make-distclean"
				((C++))
			done
		fi
		write_distclean >> "make-distclean"
		
		if [ "true" = "${doRef:-false}" ]
		then	echo >> "make-install"
			echo "mkdir -p ${CHROOT}${FHS[sysconfdir]} ; cp \"$REFERENCE\" \"${CHROOT}${FHS[sysconfdir]}/$APP.conf\"" >> "make-install"
			echo "rm -f ${CHROOT}${FHS[sysconfdir]}/$APP.conf" >> "make-uninstall"
		fi
		
		# Check for post operations, letter better here, than with 'set -s'
		if [ -n "$(echo ${POST[@]})" ]
		then 	C=0
			echo >> "make-install"
			while 	item="${POST[$C]}"
				[ ! -z "$item" ]
			do 	[ -f "$item" ] && \
					echo "sh ./$item" >> "make-install" || \
					echo "$item" >> "make-install"
				((C++))
			done
		fi
		for m in install uninstall distclean
		do	echo >> "make-$m"
			printf '%s\n' \
				"RET=\$?" \
				"set +x" >> "make-$m"
		done
		
		# Do the PREPARE stuff, before telling to call ./make-install
		if [ -n "$(echo ${PREPARE[@]})" ]
		then 	C=0
			while 	item="${PREPARE[$C]}"
				[ ! -z "$item" ]
			do 	[ -f "$item" ] && \
					bash ./"$item" || \
					( echo "$item" > "$TMP" ; bash -x "$TMP" && rm -f "$TMP")
				((C++))
			done
		fi
		# Let the script exit with their proper exit code.
		echo "echo;echo \"Finished installation of $APP\";exit \$RET" >> "make-install"
		echo "exit \$RET" >> "make-uninstall"
		echo "exit \$RET" >> "make-distclean"
		
		sed s,'set -x',"set -x\nSYSCONFDIR=$SYSCONFDIR",g -i make-{uni,i}nstall
		sed s,'~',"$HOME",g -i make-{uni,i}nstall
	}
#
#	Get options
#
	GETOPT=$(getopt \
		--options	"h" \
		--longoptions	"help,version,sample,sample-full,chroot:,tarball,bindir:,sbindir:,prefix:,datarootdir:,datadir:,infodir:,man[1-9]dir:,localedir:,docdir:,compldir:,sharedstatedir:,localstatedir:,localedir:" \
		--name 		"${0##*/}" -- "${@}"
	)
	eval set -- "$GETOPT"
	while true
	do 	case "$1" in
		-h|--help)	show_help	;;
		--version)	show_version	;;
		--sample)	show_sample	;;
		--sample-full)	show_sample_full;;
		--prefix|--bindir|--sbindir|--datarootdir|--datadir|\
		--infodir|--sysconfdir|--man[1-9]dir|--docdir|--htmldir|\
		--compldir|--sharedstatedir|--localstatedir|--localedir)
				FHS["${1/--}"]="$2"
				shift 2		;;
		--tarball)	doTarball=true
				shift 		;;
		--chroot)	CHROOT="$2"
				shift 2		;;
		--)		shift ; break	;;
		esac
	done
	[ -z "$APP" ] && echo "Missing APP name..." && exit 1
	REFERENCE="${APP}_dirs.conf"
#
#	Prepare paths
#
	for index in $index_list
	do
		tmp="${FHS[$index]}"
		etc_done=false
		if [ -z "$tmp" ]
		then	case "$index" in
			prefix)		tmp="${APP_DIR:-/usr/local}"	;;
			"bindir")	tmp="${FHS[prefix]}/bin"	;;
			"sbindir")	tmp="${FHS[prefix]}/sbin"	;;
			sysconfdir)	tmp_prefix="${FHS[prefix]}"
					case "$tmp_prefix" in
					"/"|"/usr")
						tmp="/etc"		;;
					*)	if $is_at_home
						then	tmp="$HOME/.local/etc"
						else	tmp="${FHS[prefix]}/etc"
						fi
						;;
					esac ; etc_done=true				;;
			datarootdir)	tmp="${FHS[prefix]}/share"	;;
			datadir)	tmp="${FHS[datarootdir]}/$APP"	;;
			infodir)	tmp="${FHS[datarootdir]}/info"	;;
			man[0-9]dir)	tmp="${FHS[datarootdir]}/man/${index:0:4}" ;;
			localedir)	tmp="${FHS[datarootdir]}/locale" ;;
			docdir)		tmp="${FHS[datarootdir]}/doc/$APP" ;;
			htmldir)	tmp="${FHS[docdir]}" ;;
			compldir)	tmp="${FHS[datarootdir]}/bash-completion/completions"	;;
			sharedstatedir)	tmp="${FHS[prefix]}/com"	;;
			localstatedir)	tmp="${FHS[prefix]}/var"	;;
			esac
			if [ "$index" = "prefix" ] && ! $etc_done
			then	# Do special handling
					[ "~" = "${tmp:0:1}" ] && tmp="${tmp/~/$HOME}"
					if [ "${tmp:0:${#HOME}}" = "$HOME" ]
					then	is_at_home=true
						install_prefix=""
						prefix_home="${{tmp/~/$HOME}/$HOME}"
						tmp="$prefix_home"
					fi
			fi
			FHS["$index"]="$tmp"
		fi
	done
	export FHS
	prefix="${FHS[prefix]}"
	source "$CONFIG"
#
#	Prepare installation script
#
	write_files
	APP_REQUIRES=""
	source "$CONFIG";missing=""
	for req in $APP_REQUIRES;do
		which $req 2>/dev/zero 1>&2 || missing+=" $req"
	done
	[ ! -z "$missing" ] && \
		printf '%s\n' "Please provide these commands before installing $APP!"  && \
		printf '::-->> %s\n' ${missing} && \
		exit 1
#
#	Output
#
	if $doTarball
	then	exclude_list="make-distclean"
		for ex in "${IGNORE[@]}";do exclude_list+=" $ex";done
		# Since we prepare the make-<files>, configure is no longer required
		opt_exclude="--exclude-ignore=configure"
		for item in $exclude_list;do opt_exclude+=" --exclude-ignore=$item";done
		
		tmp_p="${PWD:-$(pwd)}"
		tmp_dir="$(dirname $tmp_p)"
		[ -z "$APP_VER" ] && \
			VERSION="" || \
			VERSION="_${APP_VER}"
		#./configure --prefix="${FHS[prefix]}"
		for t in "${PRIOR[@]}"
		do 	(set -x ; $t )
		done
		tarball="../${APP}$VERSION.tar.gz"
		set -x
		tar 	-acf "$tarball" \
			--hard-dereference \
			$opt_exclude * && \
			echo "Successfully created tarball ${tarball}!"
		set +x
	else	echo
		echo "The installation script has been configured to ${CHROOT}${FHS[prefix]} (${FHS[prefix]})."
		echo "To install \"$APP\" now, please execute: '${install_prefix}./make-install'"
		echo
	fi
	exit